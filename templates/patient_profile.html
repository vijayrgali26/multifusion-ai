<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Profile - MedAI Fusion</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
      }

      header h1 {
        font-size: 2em;
        margin-bottom: 10px;
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #ddd;
      }

      .tab-btn {
        padding: 12px 20px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 1em;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }

      .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .form-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .form-section h3 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
      }

      input,
      select,
      textarea {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1em;
        font-family: inherit;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      button {
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s;
      }

      button:hover {
        transform: translateY(-2px);
      }

      .prediction-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .prediction-card h4 {
        color: #667eea;
        margin-bottom: 10px;
      }

      .risk-score {
        font-size: 1.5em;
        font-weight: bold;
        color: #667eea;
      }

      .risk-level {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
        margin-left: 10px;
      }

      .risk-level.low {
        background: #d4edda;
        color: #155724;
      }

      .risk-level.medium {
        background: #fff3cd;
        color: #856404;
      }

      .risk-level.high {
        background: #f8d7da;
        color: #721c24;
      }

      .image-upload {
        border: 2px dashed #667eea;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .image-upload:hover {
        background: rgba(102, 126, 234, 0.1);
      }

      .image-upload input[type="file"] {
        display: none;
      }

      .success-message {
        padding: 12px 16px;
        background: #d4edda;
        color: #155724;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid #c3e6cb;
      }

      .error-message {
        padding: 12px 16px;
        background: #f8d7da;
        color: #721c24;
        border-radius: 5px;
        margin-bottom: 15px;
        border: 1px solid #f5c6cb;
      }

      .chart-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-card h4 {
        font-size: 0.9em;
        opacity: 0.9;
        margin-bottom: 10px;
      }

      .stat-card .value {
        font-size: 2em;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üë§ My Health Profile</h1>
        <p id="patientIdDisplay">Patient ID will appear here</p>
      </header>

      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('profile')">
          Profile
        </button>
        <button class="tab-btn" onclick="switchTab('history')">
          Prediction History
        </button>
        <button class="tab-btn" onclick="switchTab('images')">
          Medical Images
        </button>
        <button class="tab-btn" onclick="switchTab('analytics')">
          Analytics
        </button>
      </div>

      <!-- Profile Tab -->
      <div id="profile" class="tab-content active">
        <div class="form-section">
          <h3>üìã Basic Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Full Name</label>
              <input
                type="text"
                id="patientName"
                placeholder="Your full name"
              />
            </div>
            <div class="form-group">
              <label>Age</label>
              <input
                type="number"
                id="patientAge"
                placeholder="Your age"
                min="0"
                max="120"
              />
            </div>
            <div class="form-group">
              <label>Gender</label>
              <select id="patientGender">
                <option value="">Select Gender</option>
                <option value="M">Male</option>
                <option value="F">Female</option>
                <option value="O">Other</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Email</label>
              <input
                type="email"
                id="patientEmail"
                placeholder="your.email@example.com"
              />
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input
                type="tel"
                id="patientPhone"
                placeholder="+91 XXXXX XXXXX"
              />
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>üè• Medical History</h3>
          <div class="form-group">
            <label>Known Conditions</label>
            <textarea
              id="medicalHistory"
              placeholder="List any chronic conditions, past surgeries, etc."
              rows="4"
            ></textarea>
          </div>

          <div class="form-group">
            <label>Current Medications</label>
            <textarea
              id="medications"
              placeholder="List all current medications"
              rows="3"
            ></textarea>
          </div>

          <div class="form-group">
            <label>Known Allergies</label>
            <textarea
              id="allergies"
              placeholder="List any medication or food allergies"
              rows="3"
            ></textarea>
          </div>
        </div>

        <div class="form-section">
          <h3>üèÉ Lifestyle Factors</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Smoking Status</label>
              <select id="smokingStatus">
                <option value="never">Never smoked</option>
                <option value="former">Former smoker</option>
                <option value="current">Current smoker</option>
              </select>
            </div>
            <div class="form-group">
              <label>Exercise (hours/week)</label>
              <input
                type="number"
                id="exerciseHours"
                placeholder="0"
                min="0"
                step="0.5"
              />
            </div>
            <div class="form-group">
              <label>Sleep (hours/night)</label>
              <input
                type="number"
                id="sleepHours"
                placeholder="7"
                min="0"
                max="24"
                step="0.5"
              />
            </div>
          </div>
        </div>

        <button onclick="saveProfile()">üíæ Save Profile</button>
        <div id="profileMessage"></div>
      </div>

      <!-- History Tab -->
      <div id="history" class="tab-content">
        <div class="form-section">
          <h3>üìä Prediction History</h3>
          <div id="predictionsContainer">
            <p>Loading your prediction history...</p>
          </div>
        </div>
      </div>

      <!-- Images Tab -->
      <div id="images" class="tab-content">
        <div class="form-section">
          <h3>üñºÔ∏è Medical Images Upload</h3>

          <div class="form-group">
            <label>Image Type</label>
            <select id="imageType">
              <option value="chest_xray">Chest X-Ray</option>
              <option value="ct_scan">CT Scan</option>
              <option value="mri">MRI Scan</option>
              <option value="ultrasound">Ultrasound</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div
            class="image-upload"
            onclick="document.getElementById('imageInput').click()"
          >
            <input
              type="file"
              id="imageInput"
              accept="image/*"
              onchange="handleImageUpload()"
            />
            <p>üì§ Click to upload image or drag and drop</p>
            <p style="font-size: 0.9em; color: #666; margin-top: 10px">
              Supported formats: JPG, PNG, DICOM
            </p>
          </div>

          <div id="imageMessage"></div>
        </div>

        <div class="form-section">
          <h3>üì∏ Uploaded Images</h3>
          <div id="imagesContainer">
            <p>No images uploaded yet.</p>
          </div>
        </div>
      </div>

      <!-- Analytics Tab -->
      <div id="analytics" class="tab-content">
        <div class="stats-grid">
          <div class="stat-card">
            <h4>Total Predictions</h4>
            <div class="value" id="totalPredictions">0</div>
          </div>
          <div class="stat-card">
            <h4>Average Risk Score</h4>
            <div class="value" id="averageRisk">-</div>
          </div>
          <div class="stat-card">
            <h4>Latest Status</h4>
            <div class="value" id="latestStatus">-</div>
          </div>
          <div class="stat-card">
            <h4>Trend</h4>
            <div class="value" id="trendIndicator">-</div>
          </div>
        </div>

        <div class="chart-container">
          <h3>üìà Risk Score Trend</h3>
          <p style="color: #999; text-align: center">
            Chart visualization will appear here
          </p>
          <canvas
            id="trendChart"
            style="max-height: 300px; display: none"
          ></canvas>
        </div>
      </div>
    </div>

    <script>
      let currentPatientId = null;

      // Initialize on load
      window.addEventListener("load", function () {
        const urlParams = new URLSearchParams(window.location.search);
        currentPatientId = urlParams.get("patient_id") || generatePatientId();
        document.getElementById("patientIdDisplay").textContent =
          `Patient ID: ${currentPatientId}`;
        loadPatientData();
        loadPredictionHistory();
      });

      function generatePatientId() {
        return "P" + Date.now().toString().slice(-8);
      }

      function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Remove active from all buttons
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(tabName).classList.add("active");

        // Add active to clicked button
        event.target.classList.add("active");
      }

      function saveProfile() {
        const profileData = {
          patient_id: currentPatientId,
          name: document.getElementById("patientName").value,
          age: document.getElementById("patientAge").value,
          gender: document.getElementById("patientGender").value,
          email: document.getElementById("patientEmail").value,
          phone: document.getElementById("patientPhone").value,
          medical_history: {
            conditions: document.getElementById("medicalHistory").value,
            medications: document.getElementById("medications").value,
            allergies: document.getElementById("allergies").value,
          },
          lifestyle_factors: {
            smoking: document.getElementById("smokingStatus").value,
            exercise_hours: document.getElementById("exerciseHours").value,
            sleep_hours: document.getElementById("sleepHours").value,
          },
        };

        fetch("/api/patient/register", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(profileData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showMessage(
                "profileMessage",
                "Profile saved successfully!",
                "success",
              );
              currentPatientId = data.patient_id;
              document.getElementById("patientIdDisplay").textContent =
                `Patient ID: ${data.patient_id}`;
            } else {
              showMessage(
                "profileMessage",
                "Error saving profile: " + data.error,
                "error",
              );
            }
          })
          .catch((error) => {
            showMessage("profileMessage", "Error: " + error.message, "error");
          });
      }

      function loadPatientData() {
        fetch(`/api/patient/${currentPatientId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.patient) {
              const patient = data.patient;
              document.getElementById("patientName").value = patient.name || "";
              document.getElementById("patientAge").value = patient.age || "";
              document.getElementById("patientGender").value =
                patient.gender || "";
              document.getElementById("patientEmail").value =
                patient.email || "";
              document.getElementById("patientPhone").value =
                patient.phone || "";

              if (patient.medical_history) {
                document.getElementById("medicalHistory").value =
                  patient.medical_history.conditions || "";
                document.getElementById("medications").value =
                  patient.medical_history.medications || "";
                document.getElementById("allergies").value =
                  patient.medical_history.allergies || "";
              }
            }
          })
          .catch((error) => console.error("Error loading patient:", error));
      }

      function loadPredictionHistory() {
        fetch(`/api/patient/${currentPatientId}/predictions?limit=10`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.predictions.length > 0) {
              let html = "";
              data.predictions.forEach((pred) => {
                const riskClass = pred.risk_level.toLowerCase();
                html += `
                            <div class="prediction-card">
                                <h4>Prediction on ${new Date(pred.created_at).toLocaleDateString()}</h4>
                                <p>
                                    <span class="risk-score">${pred.confidence_score.toFixed(1)}%</span>
                                    <span class="risk-level ${riskClass}">${pred.risk_level}</span>
                                </p>
                                <p><small>Type: ${pred.prediction_type}</small></p>
                                <p><small>${pred.explanation}</small></p>
                            </div>
                        `;
              });
              document.getElementById("predictionsContainer").innerHTML = html;

              // Update analytics
              document.getElementById("totalPredictions").textContent =
                data.count;
              const avgConfidence =
                data.predictions.reduce(
                  (sum, p) => sum + p.confidence_score,
                  0,
                ) / data.count;
              document.getElementById("averageRisk").textContent =
                avgConfidence.toFixed(1) + "%";
              document.getElementById("latestStatus").textContent =
                data.predictions[0].risk_level;
            } else {
              document.getElementById("predictionsContainer").innerHTML =
                "<p>No prediction history yet.</p>";
            }
          })
          .catch((error) => console.error("Error loading predictions:", error));
      }

      function handleImageUpload() {
        const fileInput = document.getElementById("imageInput");
        const file = fileInput.files[0];

        if (!file) return;

        const formData = new FormData();
        formData.append("patient_id", currentPatientId);
        formData.append(
          "image_type",
          document.getElementById("imageType").value,
        );
        formData.append("image", file);

        fetch("/api/upload-medical-image", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showMessage(
                "imageMessage",
                `Image uploaded successfully! Risk Score: ${data.risk_score}%`,
                "success",
              );
              fileInput.value = "";
            } else {
              showMessage(
                "imageMessage",
                "Error uploading image: " + data.error,
                "error",
              );
            }
          })
          .catch((error) => {
            showMessage("imageMessage", "Error: " + error.message, "error");
          });
      }

      function showMessage(elementId, message, type) {
        const messageDiv = document.getElementById(elementId);
        messageDiv.className =
          type === "success" ? "success-message" : "error-message";
        messageDiv.textContent = message;
        setTimeout(() => {
          messageDiv.textContent = "";
        }, 5000);
      }
    </script>
  </body>
</html>
